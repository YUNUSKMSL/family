<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Saha Takip + OCR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
    :root { --primary: #2563eb; --success: #16a34a; --warning: #ca8a04; --danger: #dc2626; --light: #f3f4f6; --dark: #1f2937; }
    body { font-family: sans-serif; background: var(--light); margin:0; padding-bottom: 50px; }
    header { background: var(--primary); color:white; padding:1rem; text-align:center; }
    .container { max-width:600px; margin:auto; padding:1rem; }
    .card { background:white; border-radius:12px; padding:1rem; margin-bottom:1rem; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    input, select, textarea, button { width:100%; padding:0.8rem; margin:0.4rem 0; border:1px solid #ddd; border-radius:8px; box-sizing:border-box; font-size:1rem; }
    button { background:var(--primary); color:white; border:none; font-weight:bold; cursor:pointer; }
    
    /* Kamera AlanÄ± */
    #camera-wrapper { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:999; flex-direction:column; align-items:center; justify-content:center; }
    video { width:90%; border:2px solid white; border-radius:8px; }
    .cam-buttons { display:flex; gap:10px; width:90%; margin-top:10px; }
    .status-msg { font-size:0.8rem; color:var(--gray); text-align:center; }
    
    .tab-bar { display:flex; background:white; margin-bottom:1rem; border-radius:8px; overflow:hidden; }
    .tab-btn { flex:1; padding:0.8rem; border:none; background:none; cursor:pointer; color:#666; }
    .tab-btn.active { background:#eff6ff; color:var(--primary); border-bottom:3px solid var(--primary); }
    .job-item { border-left:5px solid var(--primary); padding:10px; margin-bottom:10px; background:#fff; border-radius:8px; }
    .report-box { background:#1f2937; color:#00ff00; padding:1rem; border-radius:8px; white-space:pre-wrap; font-family:monospace; position:relative; }
</style>
</head>
<body>

<header><h1>âš¡ Ekip Takip + TarayÄ±cÄ±</h1></header>

<div id="loginSection" class="container" style="text-align:center; margin-top:50px;">
    <div class="card">
        <h3>Ekip/Plaka Girin</h3>
        <input type="text" id="teamCode" placeholder="Ã–rn: 06EVB104" style="text-transform:uppercase; text-align:center;">
        <button onclick="girisYap()">Sistemi BaÅŸlat</button>
    </div>
</div>

<div id="appSection" style="display:none;" class="container">
    <div class="tab-bar">
        <button class="tab-btn active" onclick="tabDegis(0)">Ä°ÅŸ Listesi</button>
        <button class="tab-btn" onclick="tabDegis(1)">Rapor Al</button>
    </div>

    <div id="tab0" class="tab-content">
        <div class="card">
            <h3>Yeni Ä°ÅŸ KaydÄ±</h3>
            <button onclick="kamerayiAc()" style="background:var(--dark);">ðŸ“· Evrak Tara (Kamera)</button>
            <p id="ocrStatus" class="status-msg">Okuma yapmak iÃ§in butona tÄ±kla</p>
            
            <input type="text" id="isMusteri" placeholder="MÃ¼ÅŸteri Ad Soyad">
            <input type="text" id="isNo" placeholder="Abone No (17...)">
            <select id="isTip">
                <option>FTTH Kurulum</option><option>FTTH ArÄ±za</option><option>IPTV Kurulum</option>
            </select>
            <input type="date" id="isTarih">
            <textarea id="isAciklama" placeholder="Ek notlar..."></textarea>
            <button onclick="ekleIs()" style="background:var(--success);">KAYDET</button>
        </div>
        <div id="isListesi"></div>
    </div>

    <div id="tab1" class="tab-content" style="display:none;">
        <div class="card">
            <h3>GÃ¼nlÃ¼k Ã–zet</h3>
            <input type="text" id="raporPlaka" placeholder="Plaka">
            <input type="time" id="kBas" value="08:17">
            <input type="time" id="kBit" value="17:17">
            <input type="date" id="raporTarih">
            <button onclick="raporUret()">Rapor FormatÄ± OluÅŸtur</button>
        </div>
        <div id="raporSonuc" class="report-box" style="display:none;">
            <span id="metinAlan"></span>
        </div>
    </div>
</div>

<div id="camera-wrapper">
    <video id="video" autoplay playsinline></video>
    <div class="cam-buttons">
        <button onclick="fotoCek()" style="background:var(--success);">FOTOÄžRAF Ã‡EK VE OKU</button>
        <button onclick="kamerayiKapat()" style="background:var(--danger);">Ä°PTAL</button>
    </div>
    <canvas id="canvas" style="display:none;"></canvas>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD2ESoJXY1Ue3_guJ_V2AW-XaG039FRdOQ",
        authDomain: "family-46cfe.firebaseapp.com",
        projectId: "family-46cfe",
        storageBucket: "family-46cfe.firebasestorage.app",
        messagingSenderId: "153626200125",
        appId: "1:153626200125:web:47818655b39207a93b4254",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentEkip = "";

    // GÄ°RÄ°Åž
    window.girisYap = () => {
        currentEkip = document.getElementById("teamCode").value.toUpperCase();
        if(!currentEkip) return alert("Kod gir!");
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("appSection").style.display = "block";
        document.getElementById("raporPlaka").value = currentEkip;
        yukleVeri();
    };

    // TAB YÃ–NETÄ°MÄ°
    window.tabDegis = (n) => {
        document.querySelectorAll('.tab-content').forEach((t, i) => t.style.display = i === n ? 'block' : 'none');
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === n));
    };

    // KAMERA Ä°ÅžLEMLERÄ°
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');

    window.kamerayiAc = async () => {
        document.getElementById('camera-wrapper').style.display = 'flex';
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
    };

    window.kamerayiKapat = () => {
        const stream = video.srcObject;
        if (stream) stream.getTracks().forEach(track => track.stop());
        document.getElementById('camera-wrapper').style.display = 'none';
    };

    window.fotoCek = async () => {
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        kamerayiKapat();
        document.getElementById('ocrStatus').innerText = "Metin okunuyor, lÃ¼tfen bekle...";

        const dataUrl = canvas.toDataURL('image/png');
        
        // Tesseract OCR Ã‡alÄ±ÅŸtÄ±r
        Tesseract.recognize(dataUrl, 'eng+tur', { logger: m => console.log(m) }).then(({ data: { text } }) => {
            analizEt(text);
        });
    };

    // OKUNAN METNÄ° ANALÄ°Z ETME (BURASI KRÄ°TÄ°K)
    function analizEt(text) {
        console.log("Okunan Ham Metin:", text);
        
        // 17 ile baÅŸlayan 10 haneli rakamÄ± bul
        const aboneNoMatch = text.match(/17\d{8}/);
        if(aboneNoMatch) document.getElementById('isNo').value = aboneNoMatch[0];

        // Ä°sim Soyisim Tahmini (BÃ¼yÃ¼k harfle yazÄ±lmÄ±ÅŸ 2 veya 3 kelimelik satÄ±rÄ± ara)
        const lines = text.split('\n');
        const isimMatch = lines.find(line => /^[A-ZÃ‡ÄžÄ°Ã–ÅžÃœ ]{5,30}$/.test(line.trim()));
        if(isimMatch) document.getElementById('isMusteri').value = isimMatch.trim();

        document.getElementById('ocrStatus').innerText = "Okuma tamamlandÄ±. Kontrol et!";
    }

    // VERÄ° TABANI Ä°ÅžLEMLERÄ°
    window.ekleIs = async () => {
        const musteri = document.getElementById("isMusteri").value;
        const no = document.getElementById("isNo").value;
        const aciklama = document.getElementById("isAciklama").value;
        const birlesikNot = `${musteri} - ${no}\n${aciklama}`;

        await addDoc(collection(db, `teams/${currentEkip}/jobs`), {
            tip: document.getElementById("isTip").value,
            tarih: document.getElementById("isTarih").value,
            aciklama: birlesikNot,
            durum: "Atanan",
            timestamp: Date.now()
        });
        alert("Kaydedildi");
    };

    function yukleVeri() {
        onSnapshot(collection(db, `teams/${currentEkip}/jobs`), (snap) => {
            const liste = document.getElementById("isListesi");
            liste.innerHTML = "";
            snap.forEach(docSnap => {
                const is = docSnap.data();
                liste.innerHTML += `
                    <div class="job-item">
                        <strong>${is.tip}</strong> - ${is.durum}<br>
                        ${is.aciklama}
                        <div style="margin-top:5px;">
                            <button onclick="durumSet('${docSnap.id}','YapÄ±lan')" style="width:auto; padding:5px; background:green;">YapÄ±ldÄ±</button>
                        </div>
                    </div>
                `;
            });
        });
    }

    window.durumSet = async (id, durum) => {
        await updateDoc(doc(db, `teams/${currentEkip}/jobs`, id), { durum });
    };

    // RAPOR ÃœRETME
    window.raporUret = async () => {
        const tarih = document.getElementById("raporTarih").value;
        const q = query(collection(db, `teams/${currentEkip}/jobs`), where("tarih", "==", tarih));
        const snap = await getDocs(q);
        
        let s = { top:0, yap:0, kal:0, ert:0, rek:0 };
        snap.forEach(d => {
            const data = d.data();
            s.top++;
            if(data.durum === "YapÄ±lan") s.yap++;
            else s.kal++;
        });

        const metin = `${document.getElementById("raporPlaka").value}
Kontak: ${document.getElementById("kBas").value} / ${document.getElementById("kBit").value}
Tarih: ${tarih}
Atanan iÅŸ: ${s.top}
YapÄ±lan: ${s.yap}

Kalan: ${s.kal}
Ertelenen: ${s.ert}
Reklamasyon: ${s.rek}`;

        document.getElementById("metinAlan").innerText = metin;
        document.getElementById("raporSonuc").style.display = "block";
    };

    // BaÅŸlangÄ±Ã§ AyarÄ±
    document.getElementById("isTarih").value = new Date().toISOString().split('T')[0];
    document.getElementById("raporTarih").value = new Date().toISOString().split('T')[0];

</script>
</body>
</html>
