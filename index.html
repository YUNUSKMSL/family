<!DOCTYPE html>
<html lang="tr">
<head>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <meta charset="UTF-8">
    <title>Saha Operasyon Takip</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --warning: #ca8a04; --danger: #dc2626; --light: #f3f4f6; --gray: #6b7280; --dark: #1f2937; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--light); margin:0; color:var(--dark); }
        header { background: var(--primary); color:white; padding:1.2rem; text-align:center; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        h1 { margin:0; font-size:1.3rem; font-weight:600; }
        .login-container { max-width:380px; margin:60px auto; background:white; padding:2rem; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.1); text-align:center; }
        .container { max-width:600px; margin:auto; padding:1rem; }
        input, select, textarea, button { width:100%; padding:0.8rem; margin:0.4rem 0; border:1px solid #d1d5db; border-radius:8px; box-sizing:border-box; font-size:1rem; outline:none; }
        input:focus, select:focus, textarea:focus { border-color:var(--primary); ring:2px solid var(--primary); }
        button { background:var(--primary); color:white; border:none; cursor:pointer; font-weight:600; margin-top:0.8rem; }
        button:active { opacity:0.9; transform:scale(0.98); }
        .tab-bar { display:flex; background:white; margin:1rem 0; border-radius:8px; overflow:hidden; box-shadow:0 1px 2px rgba(0,0,0,0.05); }
        .tab-btn { flex:1; padding:1rem; background:white; color:var(--gray); border-radius:0; margin:0; border-bottom:3px solid transparent; }
        .tab-btn.active { color:var(--primary); border-bottom-color:var(--primary); background:#eff6ff; }
        .section { display:none; }
        .section.active { display:block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        .card { background:white; border-radius:10px; padding:1rem; margin-bottom:1rem; box-shadow:0 1px 3px rgba(0,0,0,0.05); border:1px solid #e5e7eb; }
        .job-item { border-left:4px solid var(--primary); padding-left:1rem; margin-bottom:1rem; padding-bottom:1rem; border-bottom:1px solid #f3f4f6; }
        .job-item:last-child { border-bottom:none; margin-bottom:0; }
        .status-badge { font-size:0.75rem; padding:0.2rem 0.6rem; border-radius:99px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; }
        .st-atanan { background:#dbeafe; color:#1e40af; }
        .st-yapilan { background:#dcfce7; color:#166534; }
        .st-ertel { background:#fef9c3; color:#854d0e; }
        .st-rek { background:#fee2e2; color:#991b1b; }
        .action-row { display:flex; gap:0.5rem; margin-top:0.8rem; overflow-x:auto; padding-bottom:5px; }
        .action-btn { font-size:0.8rem; padding:0.5rem 0.8rem; border-radius:6px; white-space:nowrap; flex:1; margin:0; }
        .report-box { background:#1f2937; color:#e5e7eb; font-family:monospace; padding:1rem; border-radius:8px; white-space:pre-wrap; font-size:0.9rem; line-height:1.5; position:relative; }
        .copy-btn { position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.2); width:auto; padding:0.3rem 0.8rem; font-size:0.8rem; margin:0; }
        
        /* YENƒ∞ EKLENEN STƒ∞LLER: SAYA√á VE MODAL */
        .stats-container { display:flex; gap:10px; margin-bottom:1rem; }
        .stat-box { flex:1; background:white; padding:10px; border-radius:8px; text-align:center; box-shadow:0 1px 2px rgba(0,0,0,0.1); border:1px solid #e5e7eb; }
        .stat-num { display:block; font-size:1.5rem; font-weight:bold; color:var(--primary); }
        .stat-label { font-size:0.75rem; color:var(--gray); text-transform:uppercase; }
        
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:white; width:90%; max-width:400px; padding:1.5rem; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<header><h1>‚ö° Saha Takip</h1></header>

<div id="loginSection" class="login-container">
    <h3>Ekip Kodu Giri≈üi</h3>
    <input type="text" id="teamCode" placeholder="Plaka / Ekip Kodu (√ñrn: 06EVB104)" style="text-transform:uppercase; text-align:center; font-weight:bold; letter-spacing:1px;">
    <button onclick="girisYap()">Sisteme Gir</button>
</div>

<div id="appSection" style="display:none;">
    <div class="container">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <div>
                <span style="font-size:0.85rem; color:var(--gray);">Aktif Ekip</span>
                <div id="displayEkip" style="font-weight:bold; font-size:1.1rem; color:var(--primary);">...</div>
            </div>
            <button onclick="cikisYap()" style="width:auto; background:#ef4444; padding:0.4rem 1rem; font-size:0.9rem;">√áƒ±kƒ±≈ü</button>
        </div>

        <div class="tab-bar">
            <button class="tab-btn active" onclick="tabDegis(0)">ƒ∞≈ü Listesi</button>
            <button class="tab-btn" onclick="tabDegis(1)">Raporla</button>
        </div>

        <div id="tab0" class="section active">
            
            <div class="stats-container">
                <div class="stat-box">
                    <span class="stat-num" id="sayacToplam">0</span>
                    <span class="stat-label">Toplam</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" id="sayacYapilan" style="color:var(--success)">0</span>
                    <span class="stat-label">Yapƒ±lan</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" id="sayacKalan" style="color:var(--warning)">0</span>
                    <span class="stat-label">Kalan</span>
                </div>
            </div>
            <div class="card">
                <h3>Yeni ƒ∞≈ü Kaydƒ±</h3>
                <button onclick="kamerayiAc()" style="background:#1f2937;">üì∑Tara (Kamera)</button>
                <p id="ocrStatus" style="font-size:0.8rem; color:gray; text-align:center;">Tarama i√ßin butona bas</p>
                
                <input type="text" id="isMusteri" placeholder="M√º≈üteri Ad Soyad (Otomatik)">
                <input type="text" id="isNo" placeholder="Abone No (17... Otomatik)">
                
                <select id="isTip">
                    <option>FTTH Kurulum</option><option>FTTH Arƒ±za</option>
                    <option>IPTV Kurulum</option><option>FTTH Ses Kurulum</option>
                    <option>FTTH-IPTV Kurulum</option><option>Harici i≈ü</option>
                </select>
                <input type="date" id="isTarih">
                <button onclick="ekleIs()" style="background:#16a34a;">KAYDET</button>
            </div>

            <div id="camera-wrapper" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:999; flex-direction:column; align-items:center; justify-content:center;">
                <video id="video" autoplay playsinline style="width:90%; border:2px solid white; border-radius:8px;"></video>
                <div style="display:flex; gap:10px; width:90%; margin-top:10px;">
                    <button onclick="fotoCek()" style="background:#16a34a; padding:15px;">FOTOƒûRAF √áEK VE TARA</button>
                    <button onclick="kamerayiKapat()" style="background:#dc2626; padding:15px;">ƒ∞PTAL</button>
                </div>
                <canvas id="canvas" style="display:none;"></canvas>
            </div>

            <div id="isListesiContainer"></div>
        </div>

        <div id="tab1" class="section">
            <div class="card">
                <h3 style="margin-top:0;">Rapor Bilgileri</h3>
                <label style="font-size:0.85rem; color:var(--gray);">Plaka</label>
                <input type="text" id="raporPlaka" style="text-transform:uppercase; font-weight:bold;">

                <div style="display:flex; gap:0.5rem;">
                    <div style="flex:1;">
                        <label style="font-size:0.85rem; color:var(--gray);">Kontak Ba≈ülangƒ±√ß</label>
                        <input type="time" id="raporBaslangic" value="08:30">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.85rem; color:var(--gray);">Kontak Biti≈ü</label>
                        <input type="time" id="raporBitis" value="17:30">
                    </div>
                </div>

                <label style="font-size:0.85rem; color:var(--gray);">Rapor Tarihi</label>
                <input type="date" id="raporTarihSecim">
                <button onclick="raporUret()">Raporu Olu≈ütur</button>
            </div>

            <div id="raporSonucAlani" style="display:none;">
                <h4 style="margin:1rem 0 0.5rem;">Kopyalanabilir Metin:</h4>
                <div class="report-box">
                    <button class="copy-btn" onclick="panoyaKopyala()">Kopyala</button>
                    <span id="finalRaporMetni"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <h3>ƒ∞≈üi D√ºzenle</h3>
        <input type="hidden" id="editId">
        
        <label style="font-size:0.8rem; color:gray;">ƒ∞≈ü Tipi</label>
        <select id="editIsTip">
            <option>FTTH Kurulum</option><option>FTTH Arƒ±za</option>
            <option>IPTV Kurulum</option><option>FTTH Ses Kurulum</option>
            <option>FTTH-IPTV Kurulum</option><option>Harici i≈ü</option>
        </select>
        
        <label style="font-size:0.8rem; color:gray;">A√ßƒ±klama (Ad, Soyad, No)</label>
        <textarea id="editAciklama" rows="4"></textarea>
        
        <div style="display:flex; gap:10px; margin-top:1rem;">
            <button onclick="duzenleKaydet()" style="background:#16a34a;">KAYDET</button>
            <button onclick="document.getElementById('editModal').style.display='none'" style="background:#9ca3af;">ƒ∞PTAL</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD2ESoJXY1Ue3_guJ_V2AW-XaG039FRdOQ",
        authDomain: "family-46cfe.firebaseapp.com",
        projectId: "family-46cfe",
        storageBucket: "family-46cfe.firebasestorage.app",
        messagingSenderId: "153626200125",
        appId: "1:153626200125:web:47818655b39207a93b4254",
        measurementId: "G-55RKG43K43"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentEkip = localStorage.getItem("saha_ekip_kodu") || "";
    let globalIsListesi = []; // D√ºzenleme i≈ülemi i√ßin verileri tutar

    // Kamera Kontrolleri
    window.kamerayiAc = async () => {
        document.getElementById('camera-wrapper').style.display = 'flex';
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        document.getElementById('video').srcObject = stream;
    };

    window.kamerayiKapat = () => {
        const video = document.getElementById('video');
        const stream = video.srcObject;
        if (stream) stream.getTracks().forEach(track => track.stop());
        document.getElementById('camera-wrapper').style.display = 'none';
    };

    window.fotoCek = async () => {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        window.kamerayiKapat();
        document.getElementById('ocrStatus').innerText = "Yazƒ±lar okunuyor, l√ºtfen bekle...";
        const dataUrl = canvas.toDataURL('image/png');
        
        try {
            const result = await Tesseract.recognize(dataUrl, 'eng+tur');
            const text = result.data.text;
            const aboneNoMatch = text.match(/17\d{8}/);
            if(aboneNoMatch) document.getElementById('isNo').value = aboneNoMatch[0];
            const satirlar = text.split('\n');
            const isimAdayi = satirlar.find(s => /^[A-Z√áƒûƒ∞√ñ≈û√ú\s]{5,30}$/.test(s.trim()));
            if(isimAdayi) document.getElementById('isMusteri').value = isimAdayi.trim();
            document.getElementById('ocrStatus').innerText = "Tarama bitti!";
        } catch(e) {
            document.getElementById('ocrStatus').innerText = "Hata olu≈ütu!";
        }
    };

    // Global Fonksiyonlar
    window.girisYap = () => {
        const kod = document.getElementById("teamCode").value.trim().toUpperCase();
        if(!kod) return alert("Ekip kodu bo≈ü olamaz");
        currentEkip = kod;
        localStorage.setItem("saha_ekip_kodu", currentEkip);
        baslatUygulama();
    };

    window.cikisYap = () => {
        localStorage.removeItem("saha_ekip_kodu");
        location.reload();
    };

    window.tabDegis = (n) => {
        document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', i===n));
        document.querySelectorAll('.section').forEach((s,i) => s.classList.toggle('active', i===n));
        if(n===1) document.getElementById("raporPlaka").value = currentEkip;
    };

    window.ekleIs = async () => {
        const tip = document.getElementById("isTip").value;
        const tarih = document.getElementById("isTarih").value;
        const musteri = document.getElementById("isMusteri").value.trim();
        const no = document.getElementById("isNo").value.trim();
        
        if(!musteri && !no) return alert("Bilgileri girin veya okutun.");
        
        const otomatikAciklama = `ƒ∞sim: ${musteri}\nNo: ${no}`;

        try {
            await addDoc(collection(db, `teams/${currentEkip}/jobs`), {
                tip, tarih, aciklama: otomatikAciklama,
                durum: "Atanan",
                timestamp: Date.now()
            });
            document.getElementById("isMusteri").value = "";
            document.getElementById("isNo").value = "";
            alert("Kayƒ±t eklendi!");
        } catch(e) { alert("Hata: "+e.message); }
    };

    window.durumGuncelle = async (id, yeniDurum) => {
        const ref = doc(db, `teams/${currentEkip}/jobs`, id);
        await updateDoc(ref, { durum: yeniDurum });
    };

    window.isSil = async (id) => {
        if(confirm("Silmek istiyor musun?")) {
            await deleteDoc(doc(db, `teams/${currentEkip}/jobs`, id));
        }
    };

    // YENƒ∞ EKLENEN: D√úZENLEME FONKSƒ∞YONLARI
    window.modalAc = (id) => {
        const kayit = globalIsListesi.find(x => x.id === id);
        if(!kayit) return;
        document.getElementById('editId').value = id;
        document.getElementById('editIsTip').value = kayit.tip;
        document.getElementById('editAciklama').value = kayit.aciklama;
        document.getElementById('editModal').style.display = 'flex';
    };

    window.duzenleKaydet = async () => {
        const id = document.getElementById('editId').value;
        const tip = document.getElementById('editIsTip').value;
        const aciklama = document.getElementById('editAciklama').value;

        try {
            const ref = doc(db, `teams/${currentEkip}/jobs`, id);
            await updateDoc(ref, { tip, aciklama });
            document.getElementById('editModal').style.display = 'none';
        } catch(e) { alert("G√ºncelleme hatasƒ±: " + e.message); }
    };
    // D√úZENLEME FONKSƒ∞YONLARI SONU

    window.raporUret = async () => {
        const tarih = document.getElementById("raporTarihSecim").value;
        const plaka = document.getElementById("raporPlaka").value;
        const bas = document.getElementById("raporBaslangic").value;
        const bit = document.getElementById("raporBitis").value;
        if(!tarih) return alert("Tarih se√ßin");
        const q = query(collection(db, `teams/${currentEkip}/jobs`), where("tarih", "==", tarih));
        const snap = await getDocs(q);
        let stats = { toplam:0, yapilan:0, ertelenen:0, reklamasyon:0, kalan:0 };
        snap.forEach(d => {
            const val = d.data();
            stats.toplam++;
            if(val.durum === "Yapƒ±lan") stats.yapilan++;
            else if(val.durum === "Ertelenen") stats.ertelenen++;
            else if(val.durum === "Reklamasyon") stats.reklamasyon++;
            else stats.kalan++;
        });
        const metin = `${plaka}\nKontak: ${bas} / ${bit}\nTarih: ${tarih}\nAtanan i≈ü: ${stats.toplam}\nYapƒ±lan: ${stats.yapilan}\n\nKalan: ${stats.kalan}\nErtelenen: ${stats.ertelenen}\nReklamasyon: ${stats.reklamasyon}`;
        document.getElementById("finalRaporMetni").innerText = metin;
        document.getElementById("raporSonucAlani").style.display = "block";
    };

    window.panoyaKopyala = () => {
        const text = document.getElementById("finalRaporMetni").innerText;
        navigator.clipboard.writeText(text).then(() => alert("Kopyalandƒ±!"));
    };

    function baslatUygulama() {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("appSection").style.display = "block";
        document.getElementById("displayEkip").innerText = currentEkip;
        
        onSnapshot(collection(db, `teams/${currentEkip}/jobs`), (snap) => {
            const div = document.getElementById("isListesiContainer");
            div.innerHTML = "";
            let veri = [];
            
            // SAYA√á DEƒûƒ∞≈ûKENLERƒ∞
            let c_toplam = 0, c_yapilan = 0, c_kalan = 0;

            snap.forEach(d => {
                const item = {id:d.id, ...d.data()};
                veri.push(item);
                
                // SAYA√á HESAPLAMA
                c_toplam++;
                if(item.durum === "Yapƒ±lan") c_yapilan++;
                else c_kalan++;
            });
            
            globalIsListesi = veri; // D√ºzenleme i√ßin global listeyi g√ºncelle
            
            // SAYA√á G√úNCELLEME
            document.getElementById("sayacToplam").innerText = c_toplam;
            document.getElementById("sayacYapilan").innerText = c_yapilan;
            document.getElementById("sayacKalan").innerText = c_kalan;

            veri.sort((a,b) => b.timestamp - a.timestamp);
            
            if(veri.length === 0) {
                div.innerHTML = "<p style='text-align:center;color:#9ca3af;'>Kayƒ±tlƒ± i≈ü yok.</p>";
                return;
            }
            
            veri.forEach(is => {
                let badgeClass = "st-atanan";
                if(is.durum === "Yapƒ±lan") badgeClass = "st-yapilan";
                else if(is.durum === "Ertelenen") badgeClass = "st-ertel";
                else if(is.durum === "Reklamasyon") badgeClass = "st-rek";
                
                div.innerHTML += `
                <div class="card job-item" style="border-left-color:${badgeClass === 'st-rek' ? '#dc2626' : (badgeClass==='st-yapilan'?'#16a34a':'#2563eb')}">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <span class="status-badge ${badgeClass}">${is.durum}</span>
                            <div style="font-weight:bold; margin-top:0.3rem;">${is.tip}</div>
                        </div>
                        <div style="font-size:0.8rem; color:#6b7280;">${is.tarih}</div>
                    </div>
                    <div style="margin:0.5rem 0; font-size:0.95rem; white-space:pre-wrap;">${is.aciklama}</div>
                    <div class="action-row">
                        <button class="action-btn" style="background:#16a34a" onclick="durumGuncelle('${is.id}', 'Yapƒ±lan')">‚úî Yapƒ±ldƒ±</button>
                        <button class="action-btn" style="background:#ca8a04" onclick="durumGuncelle('${is.id}', 'Ertelenen')">‚è≥ Ertele</button>
                        <button class="action-btn" style="background:#dc2626" onclick="durumGuncelle('${is.id}', 'Reklamasyon')">‚ùå Reklam</button>
                        <button class="action-btn" style="background:#2563eb" onclick="modalAc('${is.id}')">‚úèÔ∏è D√ºzenle</button>
                        <button class="action-btn" style="background:#9ca3af" onclick="isSil('${is.id}')">üóë Sil</button>
                    </div>
                </div>`;
            });
        });
    }

    const bugun = new Date().toISOString().split('T')[0];
    document.getElementById("isTarih").value = bugun;
    document.getElementById("raporTarihSecim").value = bugun;

    if(currentEkip) {
        document.getElementById("teamCode").value = currentEkip;
        baslatUygulama();
    }
</script>
</body>
</html>
