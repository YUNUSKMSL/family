<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Ä°ÅŸ Takip Sistemi - Ekip</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    :root { --primary: #1e40af; --success: #16a34a; --warning: #ca8a04; --danger: #dc2626; --light: #f3f4f6; --gray: #6b7280; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin:0; color:#1f2937; }
    
    header { background: linear-gradient(135deg, var(--primary), #1e3a8a); color:white; padding:1.5rem; text-align:center; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); }
    h1 { margin:0; font-size:1.5rem; }
    
    .login-container { max-width:400px; margin:80px auto; background:white; padding:2rem; border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,0.1); text-align:center; }
    
    .container { max-width:800px; margin:auto; padding:1rem; }
    
    input, textarea, select, button { width:100%; padding:0.8rem; margin:0.5rem 0; border:1px solid #d1d5db; border-radius:8px; box-sizing:border-box; font-size:1rem; }
    textarea { min-height:80px; resize:vertical; }
    
    button { background:var(--primary); color:white; border:none; cursor:pointer; font-weight:600; transition:0.2s; }
    button:active { transform:scale(0.98); }
    
    .tab-bar { display:flex; background:white; border-bottom:2px solid #e5e7eb; margin:1rem 0; border-radius:8px 8px 0 0; overflow:hidden; }
    .tab-btn { flex:1; padding:1rem; border:none; background:white; font-weight:600; color:var(--gray); cursor:pointer; margin:0; border-radius:0; }
    .tab-btn.active { color:var(--primary); border-bottom:3px solid var(--primary); background:#eff6ff; }
    
    .section { display:none; animation: fadeIn 0.3s; }
    .section.active { display:block; }
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    
    .card { background:white; border-radius:12px; padding:1.2rem; margin-bottom:1rem; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
    
    .job-card { border-left:5px solid var(--primary); }
    
    /* Dinamik Durum Renkleri */
    .status { padding:0.25rem 0.8rem; border-radius:99px; font-size:0.85rem; font-weight:700; display:inline-block; }
    .status-atanan { background:#dbeafe; color:#1e40af; }
    .status-yapilan { background:#dcfce7; color:var(--success); }
    .status-ertelenen { background:#fef3c7; color:var(--warning); }
    .status-reklamasyon { background:#fee2e2; color:var(--danger); }
    
    .actions { display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:1rem; }
    .actions button { width:auto; padding:0.5rem 1rem; font-size:0.85rem; border-radius:6px; flex:1; }
    
    .btn-complete { background:var(--success); }
    .btn-ertel { background:var(--warning); }
    .btn-rek { background:var(--danger); }
    .btn-delete { background:#9ca3af; }
    
    .info-bar { display:flex; justify-content:space-between; align-items:center; margin:1rem 0; background:white; padding:1rem; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<header>
    <h1>ğŸ—ï¸ Ekip Ä°ÅŸ Takip</h1>
</header>

<div id="login" class="login-container">
    <h2 style="color:var(--primary);">Ekip GiriÅŸi</h2>
    <p style="color:var(--gray);margin-bottom:1rem;">Ekip kodunuzu girerek iÅŸlerinizi yÃ¶netin.</p>
    <input type="text" id="teamCode" placeholder="KOD (Ã–rn: ANK06)" autofocus style="text-transform:uppercase; text-align:center; letter-spacing:2px; font-weight:bold;">
    <button onclick="girisYap()">GiriÅŸ Yap</button>
</div>

<div id="mainApp" style="display:none;">
    <div class="container">
        
        <div class="info-bar">
            <div>
                <span style="color:var(--gray); font-size:0.9rem;">Aktif Ekip:</span>
                <div id="ekipAdi" style="font-weight:bold; font-size:1.2rem; color:var(--primary);"></div>
            </div>
            <button onclick="location.reload()" style="background:#ef4444; width:auto; padding:0.5rem 1.2rem;">Ã‡Ä±kÄ±ÅŸ</button>
        </div>

        <div class="tab-bar">
            <button class="tab-btn active" onclick="tabGoster(0)">ğŸ“‹ Ä°ÅŸ Listesi</button>
            <button class="tab-btn" onclick="tabGoster(1)">ğŸ“Š Rapor</button>
        </div>

        <div id="tab0" class="section active">
            <div class="card">
                <h3 style="margin-top:0;">Yeni Ä°ÅŸ Ekle</h3>
                <div style="display:flex; gap:0.5rem;">
                    <select id="isTipi" style="flex:1;">
                        <option>FTTH Kurulum</option>
                        <option>FTTH ArÄ±za</option>
                        <option>IPTV Kurulum</option>
                        <option>IPTV ArÄ±za</option>
                        <option>Ses Kurulum</option>
                        <option>Ses ArÄ±za</option>
                        <option>Harici Ä°ÅŸ</option>
                    </select>
                    <input type="date" id="isTarihi" style="flex:1;">
                </div>
                <textarea id="isAciklama" placeholder="Adres, abone no, notlar..."></textarea>
                <button onclick="isEkle()">Listeye Ekle</button>
            </div>

            <h3 style="color:var(--gray); margin-left:0.5rem;">Mevcut Ä°ÅŸler</h3>
            <div id="isListesi">
                <p style="text-align:center; color:var(--gray);">YÃ¼kleniyor...</p>
            </div>
        </div>

        <div id="tab1" class="section">
            <div class="card">
                <h3>GÃ¼nlÃ¼k Rapor</h3>
                <div style="display:flex; gap:1rem; align-items:center;">
                    <input type="date" id="raporTarihi">
                    <button onclick="raporOlustur()" style="width:auto;">Sorgula</button>
                </div>
                <div id="raporIcerik" style="margin-top:1.5rem; border-top:1px solid #eee; padding-top:1rem;">
                    <p style="color:var(--gray);">Tarih seÃ§ip sorgulayÄ±n.</p>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD2ESoJXY1Ue3_guJ_V2AW-XaG039FRdOQ",
        authDomain: "family-46cfe.firebaseapp.com",
        projectId: "family-46cfe",
        storageBucket: "family-46cfe.firebasestorage.app",
        messagingSenderId: "153626200125",
        appId: "1:153626200125:web:47818655b39207a93b4254",
        measurementId: "G-55RKG43K43"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentEkip = "";

    // --- FONKSÄ°YONLAR ---

    function girisYap() {
        const inputVal = document.getElementById("teamCode").value;
        currentEkip = inputVal.trim().toUpperCase();
        
        if (!currentEkip) {
            alert("LÃ¼tfen bir ekip kodu girin!");
            return;
        }

        // EkranÄ± deÄŸiÅŸtir
        document.getElementById("login").style.display = "none";
        document.getElementById("mainApp").style.display = "block";
        document.getElementById("ekipAdi").textContent = currentEkip;

        // Ä°ÅŸleri yÃ¼kle
        yukleIsler();
    }

    function tabGoster(n) {
        const btns = document.querySelectorAll('.tab-btn');
        const sects = document.querySelectorAll('.section');
        
        btns.forEach(b => b.classList.remove('active'));
        sects.forEach(s => s.classList.remove('active'));

        btns[n].classList.add('active');
        sects[n].classList.add('active');
    }

    async function isEkle() {
        const tip = document.getElementById("isTipi").value;
        const tarihEl = document.getElementById("isTarihi");
        let tarih = tarihEl.value;
        
        // EÄŸer tarih boÅŸsa bugÃ¼nÃ¼ ata
        if(!tarih) {
            tarih = new Date().toISOString().split('T')[0];
            tarihEl.value = tarih;
        }

        const aciklama = document.getElementById("isAciklama").value.trim();

        if (!aciklama) {
            alert("LÃ¼tfen en azÄ±ndan kÄ±sa bir aÃ§Ä±klama veya adres yazÄ±n.");
            return;
        }

        try {
            await addDoc(collection(db, `teams/${currentEkip}/jobs`), {
                tip: tip,
                tarih: tarih,
                aciklama: aciklama,
                durum: "Atanan", // VarsayÄ±lan durum
                olusturulma: Date.now()
            });
            
            // Formu temizle
            document.getElementById("isAciklama").value = "";
            // alert("Ä°ÅŸ baÅŸarÄ±yla eklendi."); // AkÄ±ÅŸÄ± bozmamak iÃ§in kapattÄ±m
        } catch (e) {
            console.error(e);
            alert("Hata: " + e.message);
        }
    }

    function yukleIsler() {
        const jobsCol = collection(db, `teams/${currentEkip}/jobs`);
        
        // VeritabanÄ±nÄ± dinle (Real-time listener)
        onSnapshot(jobsCol, (snap) => {
            const liste = document.getElementById("isListesi");
            liste.innerHTML = "";

            if (snap.empty) {
                liste.innerHTML = "<div style='text-align:center; padding:2rem; color:var(--gray);'>HenÃ¼z kayÄ±tlÄ± iÅŸ yok. <br>YukarÄ±dan ekleyebilirsin.</div>";
                return;
            }

            // Ä°ÅŸleri tarihe gÃ¶re sÄ±ralayabiliriz (Opsiyonel, ÅŸu an karÄ±ÅŸÄ±k gelir)
            // Firebase'de sÄ±ralama iÃ§in 'query' ve 'orderBy' gerekir ama index ister.
            // Basitlik iÃ§in istemcide ters Ã§evirelim (yeni eklenen altta kalmasÄ±n diye)
            let docs = [];
            snap.forEach(d => docs.push({id: d.id, ...d.data()}));
            
            // OluÅŸturulma tarihine gÃ¶re tersten sÄ±rala (En yeni en Ã¼stte)
            docs.sort((a,b) => b.olusturulma - a.olusturulma);

            docs.forEach((is) => {
                // CSS class belirleme
                let statusClass = "status-atanan";
                let durumText = is.durum;
                
                if (durumText === "YapÄ±lan") statusClass = "status-yapilan";
                else if (durumText === "Ertelenen") statusClass = "status-ertelenen";
                else if (durumText === "Reklamasyon") statusClass = "status-reklamasyon";

                const card = document.createElement("div");
                card.className = "card job-card";
                card.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.5rem;">
                        <div>
                            <div style="font-weight:bold; color:var(--primary); font-size:1.05rem;">${is.tip}</div>
                            <div style="font-size:0.85rem; color:var(--gray);">ğŸ“… ${is.tarih}</div>
                        </div>
                        <span class="status ${statusClass}">${durumText}</span>
                    </div>
                    
                    <div style="background:#f9fafb; padding:0.8rem; border-radius:8px; margin:0.5rem 0; color:#374151; white-space:pre-wrap; font-size:0.95rem;">${is.aciklama}</div>
                    
                    <div class="actions">
                        <button class="btn-complete" onclick="durumDegistir('${is.id}', 'YapÄ±lan')">âœ… YapÄ±ldÄ±</button>
                        <button class="btn-ertel" onclick="durumDegistir('${is.id}', 'Ertelenen')">â³ Ertele</button>
                        <button class="btn-rek" onclick="durumDegistir('${is.id}', 'Reklamasyon')">âŒ Reklam</button>
                        <button class="btn-delete" onclick="isSil('${is.id}')">ğŸ—‘ Sil</button>
                    </div>
                `;
                liste.appendChild(card);
            });
        });
    }

    async function durumDegistir(id, yeniDurum) {
        try {
            const isRef = doc(db, `teams/${currentEkip}/jobs`, id);
            await updateDoc(isRef, { durum: yeniDurum });
        } catch (e) {
            alert("Durum gÃ¼ncellenemedi: " + e.message);
        }
    }

    async function isSil(id) {
        if (!confirm("Bu kaydÄ± silmek istediÄŸine emin misin?")) return;
        try {
            const isRef = doc(db, `teams/${currentEkip}/jobs`, id);
            await deleteDoc(isRef);
        } catch (e) {
            alert("Silinemedi: " + e.message);
        }
    }

    async function raporOlustur() {
        const tarih = document.getElementById("raporTarihi").value;
        if (!tarih) return alert("LÃ¼tfen bir tarih seÃ§in.");

        const jobsCol = collection(db, `teams/${currentEkip}/jobs`);
        // Sadece seÃ§ili tarihteki iÅŸleri getir
        const q = query(jobsCol, where("tarih", "==", tarih));

        try {
            const snap = await getDocs(q);
            
            let istatistik = {
                toplam: 0,
                yapilan: 0,
                ertelenen: 0,
                reklamasyon: 0,
                bekleyen: 0
            };

            snap.forEach(d => {
                const data = d.data();
                istatistik.toplam++;
                
                if (data.durum === "YapÄ±lan") istatistik.yapilan++;
                else if (data.durum === "Ertelenen") istatistik.ertelenen++;
                else if (data.durum === "Reklamasyon") istatistik.reklamasyon++;
                else istatistik.bekleyen++;
            });

            const html = `
                <h4 style="margin-bottom:1rem; color:var(--primary);">${tarih} Tarihli Rapor</h4>
                <ul style="list-style:none; padding:0; font-size:1rem; line-height:1.8;">
                    <li>ğŸ“‹ <strong>Toplam KayÄ±t:</strong> ${istatistik.toplam}</li>
                    <li style="color:var(--success);">âœ… <strong>YapÄ±lan:</strong> ${istatistik.yapilan}</li>
                    <li style="color:var(--warning);">â³ <strong>Ertelenen:</strong> ${istatistik.ertelenen}</li>
                    <li style="color:var(--danger);">âŒ <strong>Reklamasyon:</strong> ${istatistik.reklamasyon}</li>
                    <li style="color:var(--primary);">ğŸ“Œ <strong>Bekleyen:</strong> ${istatistik.bekleyen}</li>
                </ul>
                ${istatistik.toplam === 0 ? '<p style="font-size:0.9rem; color:red;">Bu tarihe ait kayÄ±t bulunamadÄ±.</p>' : ''}
            `;
            
            document.getElementById("raporIcerik").innerHTML = html;

        } catch (e) {
            console.error(e);
            alert("Rapor oluÅŸturulurken hata: " + e.message);
        }
    }

    // --- Ã–NEMLÄ°: FonksiyonlarÄ± Global Yapma ---
    // Module yapÄ±sÄ± kullandÄ±ÄŸÄ±mÄ±z iÃ§in HTML'den eriÅŸilebilmeleri adÄ±na window'a atÄ±yoruz.
    window.girisYap = girisYap;
    window.tabGoster = tabGoster;
    window.isEkle = isEkle;
    window.durumDegistir = durumDegistir;
    window.isSil = isSil;
    window.raporOlustur = raporOlustur;

    // BaÅŸlangÄ±Ã§ AyarlarÄ±
    const bugun = new Date().toISOString().split('T')[0];
    document.getElementById("isTarihi").value = bugun;
    document.getElementById("raporTarihi").value = bugun;

</script>
</body>
</html>
