<!DOCTYPE html>
<html lang="tr">
<head>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <meta charset="UTF-8">
    <title>Saha Operasyon Takip</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --warning: #ca8a04; --danger: #dc2626; --light: #f3f4f6; --gray: #6b7280; --dark: #1f2937; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--light); margin:0; color:var(--dark); }
        header { background: var(--primary); color:white; padding:1.2rem; text-align:center; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        h1 { margin:0; font-size:1.3rem; font-weight:600; }
        .login-container { max-width:380px; margin:60px auto; background:white; padding:2rem; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.1); text-align:center; }
        .container { max-width:600px; margin:auto; padding:1rem; }
        input, select, textarea, button { width:100%; padding:0.8rem; margin:0.4rem 0; border:1px solid #d1d5db; border-radius:8px; box-sizing:border-box; font-size:1rem; outline:none; }
        input:focus, select:focus, textarea:focus { border-color:var(--primary); ring:2px solid var(--primary); }
        button { background:var(--primary); color:white; border:none; cursor:pointer; font-weight:600; margin-top:0.8rem; }
        button:active { opacity:0.9; transform:scale(0.98); }
        .tab-bar { display:flex; background:white; margin:1rem 0; border-radius:8px; overflow:hidden; box-shadow:0 1px 2px rgba(0,0,0,0.05); }
        .tab-btn { flex:1; padding:1rem; background:white; color:var(--gray); border-radius:0; margin:0; border-bottom:3px solid transparent; }
        .tab-btn.active { color:var(--primary); border-bottom-color:var(--primary); background:#eff6ff; }
        .section { display:none; }
        .section.active { display:block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        .card { background:white; border-radius:10px; padding:1rem; margin-bottom:1rem; box-shadow:0 1px 3px rgba(0,0,0,0.05); border:1px solid #e5e7eb; }
        .job-item { border-left:4px solid var(--primary); padding-left:1rem; margin-bottom:1rem; padding-bottom:1rem; border-bottom:1px solid #f3f4f6; }
        .job-item:last-child { border-bottom:none; margin-bottom:0; }
        .status-badge { font-size:0.75rem; padding:0.2rem 0.6rem; border-radius:99px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; }
        .st-atanan { background:#dbeafe; color:#1e40af; }
        .st-yapilan { background:#dcfce7; color:#166534; }
        .st-ertel { background:#fef9c3; color:#854d0e; }
        .st-rek { background:#fee2e2; color:#991b1b; }
        .action-row { display:flex; gap:0.5rem; margin-top:0.8rem; overflow-x:auto; padding-bottom:5px; }
        .action-btn { font-size:0.8rem; padding:0.5rem 0.8rem; border-radius:6px; white-space:nowrap; flex:1; margin:0; }
        .report-box { background:#1f2937; color:#e5e7eb; font-family:monospace; padding:1rem; border-radius:8px; white-space:pre-wrap; font-size:0.9rem; line-height:1.5; position:relative; }
        .copy-btn { position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.2); width:auto; padding:0.3rem 0.8rem; font-size:0.8rem; margin:0; }
        .stats-container { display:flex; gap:10px; margin-bottom:1rem; }
        .stat-box { flex:1; background:white; padding:10px; border-radius:8px; text-align:center; box-shadow:0 1px 2px rgba(0,0,0,0.1); border:1px solid #e5e7eb; }
        .stat-num { display:block; font-size:1.5rem; font-weight:bold; color:var(--primary); }
        .stat-label { font-size:0.75rem; color:var(--gray); text-transform:uppercase; }
        .search-box { margin-bottom: 1rem; position: relative; }
        .search-box input { padding-left: 2.5rem; border-radius: 99px; border: 1px solid #e5e7eb; }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); opacity: 0.5; }
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:white; width:90%; max-width:400px; padding:1.5rem; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<header><h1>‚ö° Saha Takip Pro</h1></header>

<div id="loginSection" class="login-container">
    <h3>Ekip Kodu Giri≈üi</h3>
    <input type="text" id="teamCode" placeholder="Plaka / Ekip Kodu" style="text-transform:uppercase; text-align:center; font-weight:bold; letter-spacing:1px;">
    <button onclick="girisYap()">Sisteme Gir</button>
</div>

<div id="appSection" style="display:none;">
    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <div>
                <span style="font-size:0.85rem; color:var(--gray);">Aktif Ekip</span>
                <div id="displayEkip" style="font-weight:bold; font-size:1.1rem; color:var(--primary);">...</div>
            </div>
            <button onclick="cikisYap()" style="width:auto; background:#ef4444; padding:0.4rem 1rem; font-size:0.9rem;">√áƒ±kƒ±≈ü</button>
        </div>

        <div class="tab-bar">
            <button class="tab-btn active" onclick="tabDegis(0)">ƒ∞≈ü Listesi</button>
            <button class="tab-btn" onclick="tabDegis(1)">Raporla</button>
        </div>

        <div id="tab0" class="section active">
            <div class="stats-container">
                <div class="stat-box">
                    <span class="stat-num" id="sayacToplam">0</span>
                    <span class="stat-label">Bug√ºn Toplam</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" id="sayacYapilan" style="color:var(--success)">0</span>
                    <span class="stat-label">Yapƒ±lan</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" id="sayacKalan" style="color:var(--warning)">0</span>
                    <span class="stat-label">Bekleyen</span>
                </div>
            </div>

            <div class="card">
                <h3>Yeni ƒ∞≈ü Kaydƒ±</h3>
                <button onclick="kamerayiAc()" style="background:#1f2937;">üì∑ Evrak Tara (Kamera)</button>
                <p id="ocrStatus" style="font-size:0.8rem; color:gray; text-align:center;">Tarama i√ßin butona bas</p>
                <input type="text" id="isMusteri" placeholder="M√º≈üteri Ad Soyad">
                <input type="text" id="isNo" placeholder="Abone No">
                <select id="isTip">
                    <option>FTTH Kurulum</option><option>FTTH Arƒ±za</option>
                    <option>IPTV Kurulum</option><option>FTTH Ses Kurulum</option>
                    <option>FTTH-IPTV Kurulum</option><option>Harici i≈ü</option>
                </select>
                <input type="date" id="isTarih">
                <button onclick="ekleIs()" style="background:#16a34a;">KAYDET</button>
            </div>

            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" placeholder="ƒ∞sim, No veya Durum ara..." onkeyup="listeyiFiltrele()">
            </div>

            <div id="camera-wrapper" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:999; flex-direction:column; align-items:center; justify-content:center;">
                <video id="video" autoplay playsinline style="width:90%; border:2px solid white; border-radius:8px;"></video>
                <div style="display:flex; gap:10px; width:90%; margin-top:10px;">
                    <button onclick="fotoCek()" style="background:#16a34a; padding:15px;">√áEK VE TARA</button>
                    <button onclick="kamerayiKapat()" style="background:#dc2626; padding:15px;">ƒ∞PTAL</button>
                </div>
                <canvas id="canvas" style="display:none;"></canvas>
            </div>

            <div id="isListesiContainer"></div>
        </div>

        <div id="tab1" class="section">
            <div class="card">
                <h3 style="margin-top:0;">Rapor Bilgileri</h3>
                <input type="text" id="raporPlaka" style="text-transform:uppercase; font-weight:bold;" placeholder="Plaka">
                <div style="display:flex; gap:0.5rem;">
                    <input type="time" id="raporBaslangic" value="08:30">
                    <input type="time" id="raporBitis" value="17:30">
                </div>
                <input type="date" id="raporTarihSecim">
                <button onclick="raporUret()">Raporu Olu≈ütur</button>
            </div>
            <div id="raporSonucAlani" style="display:none;">
                <div class="report-box">
                    <button class="copy-btn" onclick="panoyaKopyala()">Kopyala</button>
                    <span id="finalRaporMetni"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <h3>ƒ∞≈üi D√ºzenle</h3>
        <input type="hidden" id="editId">
        <select id="editIsTip">
            <option>FTTH Kurulum</option><option>FTTH Arƒ±za</option>
            <option>IPTV Kurulum</option><option>FTTH Ses Kurulum</option>
            <option>FTTH-IPTV Kurulum</option><option>Harici i≈ü</option>
        </select>
        <textarea id="editAciklama" rows="4"></textarea>
        <div style="display:flex; gap:10px;">
            <button onclick="duzenleKaydet()" style="background:#16a34a;">KAYDET</button>
            <button onclick="document.getElementById('editModal').style.display='none'" style="background:#9ca3af;">ƒ∞PTAL</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD2ESoJXY1Ue3_guJ_V2AW-XaG039FRdOQ",
        authDomain: "family-46cfe.firebaseapp.com",
        projectId: "family-46cfe",
        storageBucket: "family-46cfe.firebasestorage.app",
        messagingSenderId: "153626200125",
        appId: "1:153626200125:web:47818655b39207a93b4254",
        measurementId: "G-55RKG43K43"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentEkip = localStorage.getItem("saha_ekip_kodu") || "";
    let globalIsListesi = []; 

    window.kamerayiAc = async () => {
        document.getElementById('camera-wrapper').style.display = 'flex';
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        document.getElementById('video').srcObject = stream;
    };

    window.kamerayiKapat = () => {
        const video = document.getElementById('video');
        if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
        document.getElementById('camera-wrapper').style.display = 'none';
    };

    window.fotoCek = async () => {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        window.kamerayiKapat();
        document.getElementById('ocrStatus').innerText = "Okunuyor...";
        const result = await Tesseract.recognize(canvas.toDataURL(), 'eng+tur');
        const text = result.data.text;
        const no = text.match(/17\d{8}/); if(no) document.getElementById('isNo').value = no[0];
        const lines = text.split('\n'); const name = lines.find(s => /^[A-Z√áƒûƒ∞√ñ≈û√ú\s]{5,30}$/.test(s.trim()));
        if(name) document.getElementById('isMusteri').value = name.trim();
        document.getElementById('ocrStatus').innerText = "Tamam!";
    };

    window.girisYap = () => {
        const kod = document.getElementById("teamCode").value.trim().toUpperCase();
        if(!kod) return; currentEkip = kod; localStorage.setItem("saha_ekip_kodu", kod); baslatUygulama();
    };

    window.cikisYap = () => { localStorage.removeItem("saha_ekip_kodu"); location.reload(); };

    window.tabDegis = (n) => {
        document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', i===n));
        document.querySelectorAll('.section').forEach((s,i) => s.classList.toggle('active', i===n));
        if(n===1) document.getElementById("raporPlaka").value = currentEkip;
    };

    window.ekleIs = async () => {
        const tip = document.getElementById("isTip").value;
        const tarih = document.getElementById("isTarih").value;
        const musteri = document.getElementById("isMusteri").value.trim();
        const no = document.getElementById("isNo").value.trim();
        if(!musteri && !no) return;
        await addDoc(collection(db, `teams/${currentEkip}/jobs`), {
            tip, tarih, aciklama: `ƒ∞sim: ${musteri}\nNo: ${no}`, durum: "Atanan", timestamp: Date.now()
        });
        document.getElementById("isMusteri").value = ""; document.getElementById("isNo").value = "";
    };

    window.durumGuncelle = async (id, yeniDurum) => {
        await updateDoc(doc(db, `teams/${currentEkip}/jobs`, id), { durum: yeniDurum });
    };

    window.isiErtele = async (id) => {
        const is = globalIsListesi.find(x => x.id === id);
        if(!is) return;
        const yarin = new Date(); yarin.setDate(yarin.getDate() + 1);
        const yarinStr = yarin.toISOString().split('T')[0];
        // Bug√ºn i√ßin durum g√ºncelle (Rapor i√ßin)
        await updateDoc(doc(db, `teams/${currentEkip}/jobs`, id), { durum: "Ertelenen" });
        // Yarƒ±n i√ßin yeni i≈ü a√ß (Ekrandan gitsin diye)
        await addDoc(collection(db, `teams/${currentEkip}/jobs`), {
            tip: is.tip, tarih: yarinStr, aciklama: is.aciklama, durum: "Atanan", timestamp: Date.now()
        });
    };

    window.isSil = async (id) => { if(confirm("Silinsin mi?")) await deleteDoc(doc(db, `teams/${currentEkip}/jobs`, id)); };

    window.modalAc = (id) => {
        const is = globalIsListesi.find(x => x.id === id);
        document.getElementById('editId').value = id; document.getElementById('editIsTip').value = is.tip;
        document.getElementById('editAciklama').value = is.aciklama; document.getElementById('editModal').style.display = 'flex';
    };

    window.duzenleKaydet = async () => {
        const id = document.getElementById('editId').value;
        await updateDoc(doc(db, `teams/${currentEkip}/jobs`, id), { 
            tip: document.getElementById('editIsTip').value, aciklama: document.getElementById('editAciklama').value 
        });
        document.getElementById('editModal').style.display = 'none';
    };

    window.raporUret = async () => {
        const tarih = document.getElementById("raporTarihSecim").value;
        const snap = await getDocs(query(collection(db, `teams/${currentEkip}/jobs`), where("tarih", "==", tarih)));
        let s = { toplam:0, yapilan:0, ertelenen:0, reklamasyon:0, kalan:0 };
        snap.forEach(d => {
            const v = d.data(); s.toplam++;
            if(v.durum === "Yapƒ±lan") s.yapilan++; else if(v.durum === "Ertelenen") s.ertelenen++;
            else if(v.durum === "Reklamasyon") s.reklamasyon++; else s.kalan++;
        });
        const metin = `${document.getElementById("raporPlaka").value}\nKontak: ${document.getElementById("raporBaslangic").value} / ${document.getElementById("raporBitis").value}\nTarih: ${tarih}\nAtanan i≈ü: ${s.toplam}\nYapƒ±lan: ${s.yapilan}\n\nKalan: ${s.kalan}\nErtelenen: ${s.ertelenen}\nReklamasyon: ${s.reklamasyon}`;
        document.getElementById("finalRaporMetni").innerText = metin; document.getElementById("raporSonucAlani").style.display = "block";
    };

    window.panoyaKopyala = () => { navigator.clipboard.writeText(document.getElementById("finalRaporMetni").innerText); alert("Kopyalandƒ±!"); };

    window.listeyiFiltrele = () => {
        const ara = document.getElementById('searchInput').value.toLowerCase();
        const bugun = new Date().toISOString().split('T')[0];
        
        const filtreli = globalIsListesi.filter(is => {
            const icerik = (is.aciklama + is.tip + is.durum).toLowerCase().includes(ara);
            // KURAL: Eƒüer arama kutusu bo≈üsa; sadece bug√ºn√ºn veya ge√ßmi≈üin "Atanan" i≈ülerini g√∂ster (Yarƒ±nkiler gizli kalsƒ±n)
            // Eƒüer arama kutusu doluysa her≈üeyi g√∂ster (Ge√ßmi≈ü aramasƒ± yapabilsin diye)
            if(ara === "") {
                return icerik && (is.tarih <= bugun);
            }
            return icerik;
        });
        listeyiYazdir(filtreli);
    };

    function listeyiYazdir(liste) {
        const div = document.getElementById("isListesiContainer"); div.innerHTML = "";
        liste.forEach(is => {
            let cl = is.durum==="Yapƒ±lan"?"st-yapilan":(is.durum==="Ertelenen"?"st-ertel":(is.durum==="Reklamasyon"?"st-rek":"st-atanan"));
            let btns = is.durum==="Atanan" ? 
                `<button class="action-btn" style="background:#16a34a" onclick="durumGuncelle('${is.id}', 'Yapƒ±lan')">‚úî Yapƒ±ldƒ±</button>
                 <button class="action-btn" style="background:#ca8a04" onclick="isiErtele('${is.id}')">‚è≥ Ertele</button>
                 <button class="action-btn" style="background:#dc2626" onclick="durumGuncelle('${is.id}', 'Reklamasyon')">‚ùå Reklamasyon</button>` :
                `<button class="action-btn" style="background:#6b7280" onclick="durumGuncelle('${is.id}', 'Atanan')">‚Ü© Geri Al</button>`;
            
            div.innerHTML += `<div class="card job-item" style="border-left-color:${is.durum==='Reklamasyon'?'#dc2626':(is.durum==='Yapƒ±lan'?'#16a34a':'#2563eb')}">
                <div style="display:flex; justify-content:space-between;">
                    <div><span class="status-badge ${cl}">${is.durum}</span><div style="font-weight:bold; margin-top:5px;">${is.tip}</div></div>
                    <div style="font-size:0.8rem; color:gray;">${is.tarih}</div>
                </div>
                <div style="margin:10px 0; font-size:0.9rem; white-space:pre-wrap;">${is.aciklama}</div>
                <div class="action-row">${btns}<button class="action-btn" style="background:#2563eb" onclick="modalAc('${is.id}')">‚úèÔ∏è</button><button class="action-btn" style="background:#9ca3af" onclick="isSil('${is.id}')">üóë</button></div>
            </div>`;
        });
    }

    function baslatUygulama() {
        document.getElementById("loginSection").style.display = "none"; document.getElementById("appSection").style.display = "block";
        document.getElementById("displayEkip").innerText = currentEkip;
        onSnapshot(collection(db, `teams/${currentEkip}/jobs`), (snap) => {
            let v = []; let st = {top:0, yap:0, kal:0};
            const bugun = new Date().toISOString().split('T')[0];
            snap.forEach(d => {
                const item = {id:d.id, ...d.data()}; v.push(item);
                if(item.tarih === bugun) { // Sadece bug√ºn√ºn istatistikleri
                    st.top++; if(item.durum==="Yapƒ±lan") st.yap++; else if(item.durum==="Atanan") st.kal++;
                }
            });
            globalIsListesi = v.sort((a,b) => b.timestamp - a.timestamp);
            document.getElementById("sayacToplam").innerText = st.top;
            document.getElementById("sayacYapilan").innerText = st.yap;
            document.getElementById("sayacKalan").innerText = st.kal;
            window.listeyiFiltrele();
        });
    }

    const t = new Date().toISOString().split('T')[0];
    document.getElementById("isTarih").value = t; document.getElementById("raporTarihSecim").value = t;
    if(currentEkip) baslatUygulama();
</script>
</body>
</html>
